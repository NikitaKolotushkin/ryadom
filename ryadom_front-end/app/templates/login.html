{% extends "base.html" %}

{% block content %}

<div class="container">
    <div class="form__wrapper">
        <form id="login_form" method="post">
            <h3>Ryadom</h3>

            <input type="email" name="email" id="email" placeholder="Электронная почта" required>
            
            <input type="password" name="password" id="password" placeholder="Пароль" required>
            
            <div class="form__remember-me" style="text-align: left; display: flex; align-items: center;">
                <input type="checkbox" id="remember_me" name="remember_me" class="form__checkbox">
                <label for="remember_me" class="form__label">Запомнить меня</label>
            </div>

            <div class="form__errors" id="form-error-message"></div>

            <button type="submit" id="submit-btn" disabled>Войти</button>
            <a href="/register">Регистрация</a>
        </form>
    </div>
</div>

<script type="module">
    import { setupSpacePrevention } from '/static/js/form-utils.js';
    import { createFormValidator } from '/static/js/form-validator.js';
    import { setupFormSubmit } from '/static/js/form-submitter.js';

    document.addEventListener('DOMContentLoaded', () => {
        const loginForm = document.getElementById('login_form');
        const submitBtn = document.getElementById('submit-btn');
        const errorMessage = document.getElementById('form-error-message');

        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const rememberMeInput = document.getElementById('remember_me');

        const errorClass = 'input-error';

        const fields = [emailInput, passwordInput];

        setupSpacePrevention(fields);

        const loginValidator = createFormValidator({
            fields,
            errorClass,
            errorMessageElement: errorMessage,
            validateField: (field) => {
                if (field === emailInput) {
                    if (!field.value.trim()) {
                        return {
                            field,
                            message: 'Почта обязательна для заполнения'
                        };
                    } else if (!/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(field.value)) {
                        return { 
                            field, 
                            message: 'Некорректный формат email' 
                        };
                    }
                }

                if (field === passwordInput) {
                    if (!field.value.trim()) {
                        return {
                            field,
                            message: 'Пароль обязателен для заполнения'
                        };
                    }
                }

                return null;
            },
            onValidationSuccess: () => {
                submitBtn.disabled = false;
            },
            onValidationFailure: () => {
                submitBtn.disabled = true;
            }
        });

        loginValidator.setupValidation();

        setupFormSubmit({
            form: loginForm,
            submitBtn,
            fields,
            errorMessageElement: errorMessage,
            prepareData: () => ({
                email: emailInput.value.trim(),
                password: passwordInput.value,
                remember_me: rememberMeInput.checked
            }),
            apiUrl: 'http://localhost:8080/api/auth/login',
            onSuccess: () => {
                window.location.href = '/';
            },
            validate: loginValidator.validateForm,
            loadingText: 'Входим...',
            defaultText: 'Войти'
        });
    });
</script>

{% endblock %}