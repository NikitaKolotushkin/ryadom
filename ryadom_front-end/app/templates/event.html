{% extends "base.html" %}

{% block content %}

    {% include "logo.html" %}

    <header class="event__header" style="background-image: url('{{ event_data.banner if event_data.banner else '/static/src/img/banner.png' }}');">
        <div class="container">
            <div class="event__header-inner">
                <div class="event__tags">
                    <p>{{ category }}</p>
                    <p>{{ 'Оффлайн' if event_data.format == 'offline' else 'Онлайн' }}</p>
                    {% if is_past %}
                        <p>Архив</p>
                    {% endif %}
                </div>
                <h3 class="event__header-title">{{ event_data.name }}</h3>
                <p class="event__header-date">{{ human_date }}</p>
                <p class="event__header-place">{{ event_data.location }}</p>
                {% if not is_past %}
                    <div class="event__header-buttons">
                        <a href="">Участвовать</a>
                        <a href=""><img src="/static/src/img/heart.png" alt=""></a>
                    </div>
                {% endif %}
            </div>
        </div>
    </header>

    <div class="container">
        <div class="event__description">
            <h3>Описание</h3>
            <p>
                {{ event_data.description }}
            </p>
        </div>
        <div class="event__program" style="display: none;">
            <h3>Программа</h3>
        </div>
        <div class="event__address">
            <h3>Локация</h3>
            {%  if event_data.format == 'offline' %}
                <div style="background: url(https://static-maps.yandex.ru/v1?ll=37.620070,55.753630&lang=ru_RU&size=650,450&z=13&pt=37.620070,55.753630,pmwtm1~37.64,55.76363,pmwtm99&apikey=API_KEY) center / cover no-repeat;" class="event__address-map"></div>
            {% endif %}
            <p>{{ event_data.address }}</p>
        </div>
        <div class="event__organizers">
            <h3>Организаторы</h3>
            <ul class="people_list">
                {% for organizer in organizers %}
                    <li>
                        <a href="">
                            <img src="{{ organizer.photo if organizer.photo else '/static/src/img/profile.png' }}" alt="">
                            <p>{{ organizer.name }}</p>
                        </a>
                    </li>
                {% endfor %}
            </ul>
        </div>
        <div class="event__partners" style="display: none;">
            <h3>Партнеры</h3>
            <ul class="people_list">
                {% for _ in range(3) %}
                <li>
                    <a href="">
                        <img src="/static/src/img/profile.png" alt="">
                        <p>Человек_name</p>
                    </a>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>

    {%  if event_data.format == 'offline' %}
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const apiKey = 'API_KEY';
                const address = encodeURIComponent('{{ event_data.address }}');
                const url = `https://geocode-maps.yandex.ru/v1/?apikey=${apiKey}&geocode=${address}&format=json`;

                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Ошибка HTTP: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        const pos = data.response?.GeoObjectCollection?.featureMember?.[0]?.GeoObject?.Point?.pos;

                        if (pos) {
                            console.log('Полученные координаты:', pos);

                            const mapElement = document.querySelector('.event__address-map');
                            if (!mapElement) {
                                console.error('Элемент карты не найден');
                                return;
                            }

                            const currentStyle = mapElement.style.background || getComputedStyle(mapElement).background;
                            const urlMatch = currentStyle.match(/url\(["']?(.*?)[^"']?["']?\)/);
                            const currentUrl = urlMatch ? urlMatch[1] : '';

                            if (!currentUrl) {
                                console.error('URL карты не найден в стилях');
                                return;
                            }

                            const [baseUrl, paramsString] = currentUrl.split('?');
                            const params = new URLSearchParams(paramsString);

                            const [lon, lat] = pos.split(' ');

                            params.set('ll', `${lon},${lat}`); 
                            params.set('pt', `${lon},${lat},pmwtm1`);

                            const newUrl = `${baseUrl}?${params.toString().replace(/%2C/g, ',')}`;

                            const styleWithoutUrl = currentStyle.replace(/url\(.*?\)/, '').trim();
                            const finalStyle = `url("${newUrl}") ${styleWithoutUrl || 'center / cover no-repeat'}`;

                            mapElement.style.background = finalStyle;

                            console.log('Карта обновлена с новыми координатами');
                        } else {
                            console.error('Координаты не найдены в ответе');
                        }
                    })
                    .catch(error => {
                        console.error(`Произошла ошибка: ${error.message}`);
                        alert(`Произошла ошибка:\n${error.message}`);
                    });
            });
        </script>
    {% endif %}
{% endblock %}