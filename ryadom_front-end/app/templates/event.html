{% extends "base.html" %}

{% block content %}

    {% include "logo.html" %}

    <header class="event__header" style="background-image: url('{{ event_data.banner if event_data.banner else '/static/src/img/banner.png' }}');">
        <div class="container">
            <div class="event__header-inner">
                <div class="event__tags">
                    <p>{{ category }}</p>
                    <p>{{ 'Оффлайн' if event_data.format == 'offline' else 'Онлайн' }}</p>
                    {% if is_past %}
                        <p>Архив</p>
                    {% endif %}
                </div>
                <h3 class="event__header-title">{{ event_data.name }}</h3>
                <p class="event__header-date">{{ human_date }}</p>
                <p class="event__header-place">{{ event_data.location }}</p>
                {% if not is_past %}
                    <div class="event__header-buttons">
                        <a href="">Участвовать</a>
                        <a href=""><img src="/static/src/img/heart.png" alt=""></a>
                    </div>
                {% endif %}
            </div>
        </div>
    </header>

    <div class="container">
        <div class="event__description">
            <h3>Описание</h3>
            <p>
                {{ event_data.description }}
            </p>
        </div>
        <div class="event__program" style="display: none;">
            <h3>Программа</h3>
        </div>
        <div class="event__address">
            <h3>Локация</h3>
            {%  if event_data.format == 'offline' %}
                <div style="background: url(https://static-maps.yandex.ru/v1?ll=37.620070,55.753630&lang=ru_RU&size=650,450&z=13&pt=37.620070,55.753630,pmwtm1~37.64,55.76363,pmwtm99&apikey=API_KEY) center / cover no-repeat;" class="event__address-map"></div>
            {% endif %}
            <p>{{ event_data.address }}</p>
        </div>
        <div class="event__organizers">
            <h3>Организаторы</h3>
            <ul class="people_list">
                {% for organizer in organizers %}
                    <li>
                        <a href="">
                            <img src="{{ organizer.photo if organizer.photo else '/static/src/img/profile.png' }}" alt="">
                            <p>{{ organizer.name }}</p>
                        </a>
                    </li>
                {% endfor %}
            </ul>
        </div>
        <div class="event__partners" style="display: none;">
            <h3>Партнеры</h3>
            <ul class="people_list">
                {% for _ in range(3) %}
                <li>
                    <a href="">
                        <img src="/static/src/img/profile.png" alt="">
                        <p>Человек_name</p>
                    </a>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>

    {%  if event_data.format == 'offline' %}
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const address = encodeURIComponent('{{ event_data.address }}');

                fetch('/api/geocode?address=' + address)
                    .then(response => {
                        if (!response.ok) throw new Error('Ошибка геокодирования');
                        return response.json();
                    })
                    .then(geocodeData => {
                        const {
                            lat,
                            lon,
                            addr
                        } = geocodeData;
                        return fetch(`/api/static-map?lat=${lat}&lon=${lon}&zoom=13&size=650,450`);
                    })
                    .then(response => {
                        if (!response.ok) throw new Error('Ошибка генерации карты');
                        return response.json();
                    })
                    .then(mapData => {
                        const mapElement = document.querySelector('.event__address-map');
                        if (!mapElement) return;

                        mapElement.style.backgroundImage = `url("${mapData.url}")`;
                        mapElement.style.backgroundSize = 'cover';
                        mapElement.style.backgroundPosition = 'center';
                    })
                    .catch(console.error);
            });
        </script>
    {% endif %}
{% endblock %}